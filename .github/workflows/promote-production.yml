name: ğŸš€ Promote to Production

# Workflow ini berjalan MANUAL
# Digunakan untuk mempromosikan image :dev ke :latest (production)
on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Ketik "DEPLOY" untuk konfirmasi promote ke production'
        required: true
        default: ''
      version_tag:
        description: 'Version tag (opsional, contoh: v1.0.0)'
        required: false
        default: ''

env:
  DOCKER_IMAGE_NAME: web-doorprize

jobs:
  # ============================================
  # JOB: Promote DEV to Production
  # ============================================
  promote:
    name: ğŸš€ Promote to Production
    runs-on: ubuntu-latest
    
    # Hanya jalan jika user mengetik "DEPLOY"
    if: github.event.inputs.confirm == 'DEPLOY'
    
    steps:
      - name: ğŸ” Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: ğŸ“¥ Pull DEV Image
        run: |
          echo "ğŸ“¥ Pulling DEV image..."
          docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:dev

      - name: ğŸ·ï¸ Tag as Production (latest)
        run: |
          echo "ğŸ·ï¸ Tagging as :latest..."
          docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:dev \
                     ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # Jika version tag diberikan, tag juga dengan versi
          if [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "ğŸ·ï¸ Tagging as :${{ github.event.inputs.version_tag }}..."
            docker tag ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:dev \
                       ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.event.inputs.version_tag }}
          fi

      - name: ğŸ“¤ Push Production Image
        run: |
          echo "ğŸ“¤ Pushing :latest to Docker Hub..."
          docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest
          
          # Push version tag jika ada
          if [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "ğŸ“¤ Pushing :${{ github.event.inputs.version_tag }} to Docker Hub..."
            docker push ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.event.inputs.version_tag }}
          fi

      - name: âœ… Production Deployed
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "ğŸ‰ PRODUCTION IMAGE BERHASIL DI-DEPLOY!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "ğŸ“¦ Production Image: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          if [ -n "${{ github.event.inputs.version_tag }}" ]; then
            echo "ğŸ“¦ Version Tag: ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:${{ github.event.inputs.version_tag }}"
          fi
          echo ""
          echo "ğŸ–¥ï¸ Untuk deploy di server production, jalankan:"
          echo "   docker pull ${{ secrets.DOCKER_USERNAME }}/${{ env.DOCKER_IMAGE_NAME }}:latest"
          echo "   docker-compose -f docker-compose.prod.yml up -d"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"

  # Job jika konfirmasi salah
  cancelled:
    name: âŒ Deployment Cancelled
    runs-on: ubuntu-latest
    if: github.event.inputs.confirm != 'DEPLOY'
    
    steps:
      - name: âŒ Invalid Confirmation
        run: |
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo "âŒ DEPLOYMENT DIBATALKAN!"
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          echo ""
          echo "Anda memasukkan: '${{ github.event.inputs.confirm }}'"
          echo "Yang diperlukan: 'DEPLOY'"
          echo ""
          echo "Silakan jalankan workflow lagi dan ketik 'DEPLOY' untuk konfirmasi."
          echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
          exit 1
